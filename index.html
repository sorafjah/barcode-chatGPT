<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>100均レジ</title>

  <!--
    目的:
    - html5-qrcode を優先して使う（要件）
    - ただし学校Wi‑Fi等でCDNがブロックされると読み込み失敗が起きる

    対策:
    1) 複数CDNで再試行（html5-qrcode）
    2) ダメならネイティブ BarcodeDetector（対応ブラウザのみ）
    3) それもダメなら「スキャン代わり」大ボタンで +110円（授業/遊び用途を止めない）

    ※ 外部API（商品DBなど）は使いません（スタンドアロン）。
  -->
  <script>
    (function(){
      if (window.Html5Qrcode) return;
      const primary = "https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js";
      const s = document.createElement('script');
      s.src = primary;
      s.async = true;
      s.crossOrigin = "anonymous";
      document.head.appendChild(s);
    })();
  </script>

  <style>
    :root{
      --pad: 16px;
      --radius: 18px;
      --shadow: 0 8px 24px rgba(0,0,0,.12);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background:#fff;
      color:#000;
      overflow:hidden;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: max(env(safe-area-inset-top), 0px) var(--pad) max(env(safe-area-inset-bottom), 0px) var(--pad);
      gap: 12px;
    }

    .top{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .card{
      border: 3px solid #000;
      border-radius: var(--radius);
      padding: 14px;
      background:#fff;
      box-shadow: var(--shadow);
    }
    .label{ font-size: 20px; font-weight: 800; }
    .big{
      font-size: clamp(44px, 7vw, 80px);
      font-weight: 1000;
      line-height: 1.05;
      margin-top: 6px;
      letter-spacing: .5px;
    }

    .scan-area{
      flex:1;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height: 0;
    }

    #readerWrap{
      flex:1;
      border: 3px solid #000;
      border-radius: var(--radius);
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow);
      min-height: 0;
      position:relative;
    }

    #reader{
      width:100%;
      height:100%;
      position:relative;
      background:#fff;
    }

    /* ネイティブフォールバック用 video */
    #nativeVideo{
      width:100%;
      height:100%;
      object-fit: cover;
      display:none;
      background:#000;
    }
    #nativeVideo.show{ display:block; }

    /* 最終フォールバック（手動追加ボタン） */
    .manualWrap{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      background:#fff;
    }
    .manualWrap.show{ display:flex; }
    .manualBtn{
      width:100%;
      height:100%;
      border: 5px solid #000;
      border-radius: 24px;
      font-size: clamp(40px, 6vw, 72px);
      font-weight: 1000;
      background:#ffeb3b;
      color:#000;
      box-shadow: var(--shadow);
    }

    .meta{
      border: 3px solid #000;
      border-radius: var(--radius);
      padding: 12px 14px;
      background:#fff;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .product{
      font-size: 28px;
      font-weight: 1000;
    }

    .buttons{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    button{
      width:100%;
      border: 3px solid #000;
      border-radius: 18px;
      padding: 18px 16px;
      font-size: 30px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: var(--shadow);
      background:#fff;
      color:#000;
      touch-action: manipulation;
    }

    .btn-start{ background:#00d084; }
    .btn-pay{ background:#ffeb3b; }
    .btn-reset{ background:#ff3b30; color:#fff; }

    .hint{
      font-size: 14px;
      font-weight: 700;
      opacity: .95;
      line-height: 1.4;
      text-align:center;
      padding-bottom: 6px;
      white-space: pre-wrap;
    }

    /* Overlay */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(255,255,255,.96);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap: 18px;
      padding: 20px;
      z-index: 50;
    }
    .overlay.show{ display:flex; }
    .overlay .totalText{
      font-size: clamp(52px, 9vw, 110px);
      font-weight: 1000;
      border: 5px solid #000;
      border-radius: 24px;
      padding: 18px 22px;
      box-shadow: var(--shadow);
      background:#fff;
      text-align:center;
      line-height: 1.1;
    }

    /* Start gate */
    .gate{
      position:fixed;
      inset:0;
      background:#fff;
      z-index: 100;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 20px;
    }
    .gate .panel{
      width:min(760px, 100%);
      border: 5px solid #000;
      border-radius: 26px;
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .gate h1{
      margin: 0 0 10px 0;
      font-size: 34px;
      font-weight: 1000;
    }
    .gate p{
      margin: 0 0 14px 0;
      font-size: 16px;
      font-weight: 700;
      line-height: 1.5;
    }

    .status{
      font-size: 14px;
      font-weight: 800;
      margin-top: 10px;
      padding: 10px 12px;
      border: 3px solid #000;
      border-radius: 14px;
      background:#fff;
      white-space: pre-wrap;
    }

    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior: auto !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="gate" id="gate">
    <div class="panel">
      <h1>100均レジ</h1>
      <p>
        最初に <b>「レジをはじめる」</b> を押すと、<b>カメラ</b> と <b>音</b> の許可を取ってスキャンを開始します。<br>
        ※ 学校Wi‑FiでCDNがブロックされる場合は、別方式か「手動ボタン」に自動で切り替えます。
      </p>
      <button class="btn-start" id="btnStart">レジをはじめる</button>
      <div class="status" id="gateStatus">待機中</div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="totalText" id="payTotal">合計 0円</div>
    <button class="btn-reset" id="btnReset2">つぎの人（リセット）</button>
  </div>

  <div class="app" aria-label="100均レジアプリ">
    <div class="top">
      <div class="card">
        <div class="label">合計金額</div>
        <div class="big" id="sum">0円</div>
      </div>
      <div class="card">
        <div class="label">スキャン個数</div>
        <div class="big" id="count">0個</div>
      </div>
    </div>

    <div class="scan-area">
      <div id="readerWrap">
        <div id="reader">
          <video id="nativeVideo" playsinline muted></video>
          <div class="manualWrap" id="manualWrap">
            <button class="manualBtn" id="manualAdd">＋110円（ピッ）</button>
          </div>
        </div>
      </div>

      <div class="meta">
        <div class="product">100円ショップの商品</div>
      </div>

      <div class="buttons">
        <button class="btn-pay" id="btnPay" disabled>お支払い</button>
        <button class="btn-reset" id="btnReset" disabled>つぎの人（リセット）</button>
      </div>

      <div class="hint" id="hint">スキャン待機中…</div>
    </div>
  </div>

  <script>
    // ================================
    // 確認（不明点）
    // ================================
    // 「バーコードが読めない環境」では、
    // この実装は「＋110円（ピッ）」ボタンで代替します。
    // もし「その環境では起動自体を止めたい」等の方針があれば言ってください。

    // ================================
    // 設定
    // ================================
    const PRICE = 110;

    // ================================
    // 状態
    // ================================
    let total = 0;
    let scanned = 0;

    // 重複対策（表示はしない）
    let lastCode = "";
    let lastScanAt = 0;

    let audioCtx = null;

    // スキャンエンジン
    let scanning = false;
    let scanMode = 'none'; // 'html5' | 'native' | 'manual'

    // html5-qrcode
    let qr = null;

    // ネイティブ
    let mediaStream = null;
    let detector = null;
    let rafId = 0;
    let lastDetectAt = 0;

    // UI
    const elSum = document.getElementById('sum');
    const elCount = document.getElementById('count');
    const elHint = document.getElementById('hint');

    const gate = document.getElementById('gate');
    const gateStatus = document.getElementById('gateStatus');

    const btnStart = document.getElementById('btnStart');
    const btnPay = document.getElementById('btnPay');
    const btnReset = document.getElementById('btnReset');
    const btnReset2 = document.getElementById('btnReset2');

    const overlay = document.getElementById('overlay');
    const payTotal = document.getElementById('payTotal');

    const nativeVideo = document.getElementById('nativeVideo');
    const manualWrap = document.getElementById('manualWrap');
    const manualAdd = document.getElementById('manualAdd');

    // ================================
    // html5-qrcode ローダー（複数CDNで再試行）
    // ================================
    function loadScript(src){
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.crossOrigin = 'anonymous';
        s.onload = () => resolve(true);
        s.onerror = () => reject(new Error('failed to load: ' + src));
        document.head.appendChild(s);
      });
    }

    async function ensureHtml5QrcodeLoaded(){
      if (window.Html5Qrcode) return { ok: true, via: 'already' };

      const candidates = [
        'https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js',
        'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js',
        'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/dist/html5-qrcode.min.js',
        'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/html5-qrcode.min.js'
      ];

      let lastErr = null;
      for (const src of candidates) {
        try {
          await loadScript(src);
          if (window.Html5Qrcode) return { ok: true, via: src };
        } catch (e) {
          lastErr = e;
        }
      }
      return { ok: false, via: null, error: lastErr };
    }

    // ================================
    // UI更新
    // ================================
    function updateUI(){
      elSum.textContent = `${total}円`;
      elCount.textContent = `${scanned}個`;

      const hasAny = scanned > 0;
      btnPay.disabled = !scanning || !hasAny;
      btnReset.disabled = false; // A: いつでも押せる
    }

    function setHint(text){
      elHint.textContent = text;
    }

    function setManualVisible(v){
      manualWrap.classList.toggle('show', !!v);
    }

    // ================================
    // 音 (Web Audio)
    // ================================
    function ensureAudio(){
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = AC ? new AC() : null;
      }
    }

    async function beep(){
      ensureAudio();
      if (!audioCtx) return;
      if (audioCtx.state === 'suspended') {
        try { await audioCtx.resume(); } catch(e) {}
      }
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'square';
      osc.frequency.value = 1760;
      gain.gain.value = 0.0001;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.35, now + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.10);
      osc.start(now);
      osc.stop(now + 0.12);
    }

    // ================================
    // 読み上げ (Web Speech)
    // ================================
    function warmVoices(){
      const synth = window.speechSynthesis;
      if (!synth) return;
      if (typeof synth.getVoices === 'function') synth.getVoices();
    }

    function speak110(){
      const synth = window.speechSynthesis;
      if (!synth || typeof SpeechSynthesisUtterance === 'undefined') return;
      try { synth.cancel(); } catch(e) {}
      const u = new SpeechSynthesisUtterance('ひゃくじゅうえん');
      u.lang = 'ja-JP';
      u.rate = 1.0;
      u.pitch = 1.0;
      u.volume = 1.0;
      const voices = synth.getVoices ? synth.getVoices() : [];
      const ja = voices.find(v => (v.lang || '').toLowerCase().startsWith('ja'));
      if (ja) u.voice = ja;
      try { synth.speak(u); } catch(e) {}
    }

    // ================================
    // 共通: 読み取り成功時の処理
    // ================================
    function extractDigits(decodedText){
      return (String(decodedText).match(/\d+/g) || []).join('');
    }

    function isValidCode(text){
      return /^\d{8,14}$/.test(text);
    }

    function addItemEffect(){
      scanned += 1;
      total += PRICE;
      updateUI();
      beep();
      setTimeout(() => speak110(), 120);
      setHint('スキャンしました！');
      setTimeout(() => {
        if (scanning) setHint('スキャン待機中…');
      }, 600);
    }

    function onAnyScanSuccess(raw){
      const now = Date.now();
      const digits = extractDigits(raw);
      if (!digits) return;
      if (!isValidCode(digits)) return;

      if (digits === lastCode && (now - lastScanAt) < 900) return;
      lastCode = digits;
      lastScanAt = now;

      addItemEffect();
    }

    // ================================
    // html5-qrcode（第一候補）
    // ================================
    async function startScannerHtml5(){
      if (!qr) qr = new window.Html5Qrcode('reader');
      const config = {
        fps: 12,
        qrbox: (w, h) => {
          const min = Math.min(w, h);
          const size = Math.floor(min * 0.72);
          return { width: size, height: size };
        },
        rememberLastUsedCamera: true,
        aspectRatio: 1.0,
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
      };
      const cameraConstraints = { facingMode: { ideal: 'environment' } };
      await qr.start(
        cameraConstraints,
        config,
        (decodedText) => onAnyScanSuccess(decodedText),
        () => {}
      );
      scanMode = 'html5';
      scanning = true;
      nativeVideo.classList.remove('show');
      setManualVisible(false);
    }

    async function stopScannerHtml5(){
      if (!qr || scanMode !== 'html5') return;
      try {
        await qr.stop();
        await qr.clear();
      } catch(e) {}
    }

    // ================================
    // ネイティブフォールバック
    // ================================
    function canUseNativeDetector(){
      return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia && window.BarcodeDetector);
    }

    async function startScannerNative(){
      detector = new BarcodeDetector({ formats: [
        'ean_13','ean_8','code_128','code_39','upc_a','upc_e','itf'
      ]});

      mediaStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      });

      nativeVideo.srcObject = mediaStream;
      nativeVideo.classList.add('show');
      await nativeVideo.play();

      scanMode = 'native';
      scanning = true;
      setManualVisible(false);

      const loop = async () => {
        if (!scanning || scanMode !== 'native') return;
        const now = Date.now();
        if (now - lastDetectAt < 120) {
          rafId = requestAnimationFrame(loop);
          return;
        }
        lastDetectAt = now;

        try {
          const barcodes = await detector.detect(nativeVideo);
          if (barcodes && barcodes.length) {
            onAnyScanSuccess(barcodes[0].rawValue || '');
          }
        } catch (e) {}

        rafId = requestAnimationFrame(loop);
      };
      rafId = requestAnimationFrame(loop);
    }

    async function stopScannerNative(){
      if (scanMode !== 'native') return;
      if (rafId) {
        cancelAnimationFrame(rafId);
        rafId = 0;
      }
      try {
        nativeVideo.pause();
        nativeVideo.srcObject = null;
        nativeVideo.classList.remove('show');
      } catch(e) {}

      if (mediaStream) {
        try { mediaStream.getTracks().forEach(t => t.stop()); } catch(e) {}
        mediaStream = null;
      }
      detector = null;
    }

    // ================================
    // 手動モード（最後の砦）
    // ================================
    function startManualMode(reason){
      scanMode = 'manual';
      scanning = true;
      nativeVideo.classList.remove('show');
      setManualVisible(true);
      gateStatus.textContent = reason;
      setHint('スキャン待機中…（手動モード）');
    }

    // ================================
    // 統合 start/stop
    // ================================
    async function startScanner(){
      if (scanning) return;
      setHint('カメラ起動中…');

      // 1) html5-qrcode を試す
      const lib = await ensureHtml5QrcodeLoaded();
      if (lib.ok && window.Html5Qrcode) {
        try {
          await startScannerHtml5();
          setHint('スキャン待機中…');
          updateUI();
          return;
        } catch (e) {
          // ライブラリはあるが起動に失敗 → 次へ
          try { await stopScannerHtml5(); } catch(_) {}
        }
      }

      // 2) ネイティブ
      if (canUseNativeDetector()) {
        try {
          await startScannerNative();
          gateStatus.textContent = 'CDN読み込みが制限されました。\nネイティブ方式でスキャンします。';
          setHint('スキャン待機中…');
          updateUI();
          return;
        } catch (e) {
          // ここもダメなら手動
        }
      }

      // 3) 手動
      const msg = lib.ok
        ? 'カメラ起動に失敗しました。\n手動モードに切り替えます。'
        : 'html5-qrcode が読み込めませんでした。\n（学校Wi‑FiのCDNブロック等）\n手動モードに切り替えます。';
      startManualMode(msg);
      updateUI();
    }

    async function stopScanner(){
      if (!scanning) return;
      setHint('停止中…');
      scanning = false;

      if (scanMode === 'html5') {
        await stopScannerHtml5();
      } else if (scanMode === 'native') {
        await stopScannerNative();
      } else if (scanMode === 'manual') {
        // 何もしない
        setManualVisible(false);
      }

      scanMode = 'none';
      setHint('停止しました');
      updateUI();
    }

    // ================================
    // お支払いフロー
    // ================================
    async function pay(){
      await stopScanner();
      payTotal.textContent = `合計 ${total}円`;
      overlay.classList.add('show');
      updateUI();
    }

    async function resetAll(){
      overlay.classList.remove('show');
      total = 0;
      scanned = 0;
      lastCode = '';
      lastScanAt = 0;
      updateUI();
      setHint('スキャン待機中…');
      try { await startScanner(); } catch(e) {}
    }

    // ================================
    // イベント
    // ================================
    manualAdd.addEventListener('click', () => {
      if (!scanning) return;
      addItemEffect();
    }, { passive: true });

    btnPay.addEventListener('click', () => {
      if (scanned <= 0) return;
      pay();
    }, { passive: true });

    btnReset.addEventListener('click', () => {
      resetAll();
    }, { passive: true });

    btnReset2.addEventListener('click', () => {
      resetAll();
    }, { passive: true });

    // ================================
    // 簡易テスト（UIに影響しない）
    // ================================
    function runSelfTests(){
      const tests = [];
      const assert = (name, cond) => tests.push({ name, pass: !!cond });

      // 既存（意味が正しいので変更しない）
      assert('isValidCode 13桁OK', isValidCode('4901234567890') === true);
      assert('isValidCode 8桁OK', isValidCode('12345678') === true);
      assert('isValidCode 7桁NG', isValidCode('1234567') === false);
      assert('isValidCode 15桁NG', isValidCode('123456789012345') === false);
      assert('extractDigits 数字抽出', extractDigits('JAN: 4901234567890') === '4901234567890');
      assert('extractDigits 混在でも連結', extractDigits('49-0123 456 7890') === '4901234567890');

      // 追加テスト
      assert('extractDigits 数字なしは空', extractDigits('ABC') === '');
      assert('canUseNativeDetector boolean', typeof canUseNativeDetector() === 'boolean');
      assert('初期モード none', scanMode === 'none');

      const failed = tests.filter(t => !t.pass);
      if (failed.length) {
        console.warn('SelfTests FAILED', failed);
      } else {
        console.log('SelfTests OK', tests.length);
      }
    }
    runSelfTests();

    // ================================
    // 開始ゲート
    // ================================
    btnStart.addEventListener('click', async () => {
      gateStatus.textContent = '準備中…';
      btnStart.disabled = true;
      btnStart.textContent = '準備中…';

      try {
        // iOS対策：ユーザー操作直後に音/音声をウォームアップ
        const synth = window.speechSynthesis;
        if (synth && typeof synth.cancel === 'function') { try { synth.cancel(); } catch(_) {} }
        warmVoices();

        ensureAudio();
        await beep();

        await startScanner();
        gate.style.display = 'none';
        setHint('スキャン待機中…');
      } catch (e) {
        console.error(e);
        gateStatus.textContent = '開始できませんでした。\n・カメラ権限\n・ネットワーク制限（CDNブロック）\nを確認してください。';
        btnStart.disabled = false;
        btnStart.textContent = 'レジをはじめる';
      }
    }, { passive: true });

    updateUI();
  </script>
</body>
</html>
